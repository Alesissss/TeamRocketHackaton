{% extends "master_page.html" %}

{% block title %}{{ _('Mapa Interactivo') }}{% endblock %}

{% block style %}
<link rel="stylesheet" href="{{ url_for('home.static_files', filename='css/map.css') }}" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
#map {
    height: 80vh;
    width: 100%;
    z-index: 1;
}

.coordinates-box {
    position: absolute;
    z-index: 1000;
    bottom: 20px;
    left: 300px;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    max-width: 600px;
    font-size: 16px;
}

.options {
    position: absolute;
    bottom: 20px;
    left: 20px;
    z-index: 1000;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.95);
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    font-size: 18px;
    font-weight: 500;
    color: #333;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(5px);
    height: 50px;
    max-width: 200px;
}

.options:hover {
    background: rgba(255, 255, 255, 1);
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

.options:focus {
    outline: 2px solid #007bff;
    outline-offset: 2px;
}

.continue-btn {
    position: absolute;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    padding: 12px 24px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(5px);
    display: none;
}

.continue-btn:hover {
    background: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

.continue-btn:active {
    transform: translateY(0);
}

.continue-btn.show {
    display: block;
}
</style>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="text-right mt-3 mb-4 justify-content-center align-items-center" style="color: white;">{{ _('Mapa Interactivo') }}</h2>
            
            <!-- Mapa -->
            <div id="map"></div>
            
            <!-- Selector de modo -->
            <select name="geometric_options" id="geometric_options" class="options">
                <option value="point" selected>üìç {{ _('Punto') }}</option>
                <option value="polygon">üî∑ {{ _('Pol√≠gono') }}</option>
            </select>
            
            <!-- Informaci√≥n de coordenadas -->
            <div id="coordinates-info" class="coordinates-box">
                <div id="point-info" style="display: none;">
                    <strong>{{ _('Punto seleccionado:') }}</strong>
                    Lat: <span id="lat">-</span>, Lng: <span id="lng">-</span>
                </div>
                <div id="polygon-info" style="display: none;">
                    <strong>{{ _('Pol√≠gono dibujado:') }}</strong>
                    <span id="polygon-coords">-</span>
                </div>
                <div id="help-info" style="font-size: 12px; color: #666; margin-top: 10px;">
                    <div id="help-point" style="display: block;">
                        üìç {{ _('Click para marcar punto') }}
                    </div>
                    <div id="help-polygon" style="display: none;">
                        üî∑ {{ _('Click para agregar puntos') }}<br>
                        {{ _('Doble-click para completar') }}
                    </div>
                </div>
            </div>
            
            <!-- Bot√≥n continuar -->
            <button id="continueBtn" class="continue-btn">
                ‚úì {{ _('Continuar') }}
            </button>
            
            <!-- Contenedor para el modal -->
            <div id="contenedorModalPredictor"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    
    // Crear mapa b√°sico
    const map = L.map('map').setView([-9.19, -75.0152], 6);
    console.log('Mapa creado');

    // Agregar tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        minZoom: 3,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    console.log('Tiles agregados');

    // Variables globales
    let marker = null;
    let currentMode = 'point';
    let polygonPoints = [];
    let currentPolygon = null;
    let tempMarkers = [];

    // Forzar redimensionamiento del mapa
    setTimeout(() => {
        map.invalidateSize();
        console.log('Mapa redimensionado');
    }, 100);

    // Funci√≥n para agregar marcador de punto
    function addPointMarker(latlng) {
        console.log('Agregando marcador en:', latlng);
        
        if (marker) {
            map.removeLayer(marker);
        }
        
        marker = L.marker(latlng).addTo(map);
        
        // Mostrar informaci√≥n
        document.getElementById('lat').textContent = latlng.lat.toFixed(6);
        document.getElementById('lng').textContent = latlng.lng.toFixed(6);
        document.getElementById('point-info').style.display = 'block';
        document.getElementById('polygon-info').style.display = 'none';
        
        // Mostrar bot√≥n continuar
        document.getElementById('continueBtn').classList.add('show');
    }

    // Funci√≥n para manejar pol√≠gono
    function addPolygonPoint(latlng) {
        console.log('Agregando punto del pol√≠gono:', latlng);
        
        polygonPoints.push(latlng);
        
        // Agregar marcador temporal
        const tempMarker = L.marker(latlng, {
            icon: L.divIcon({
                className: 'polygon-point',
                html: '<div style="background-color: #ff6b6b; width: 8px; height: 8px; border-radius: 50%; border: 2px solid white;"></div>',
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            })
        }).addTo(map);
        
        tempMarkers.push(tempMarker);
        
        if (polygonPoints.length >= 3) {
            // Crear o actualizar pol√≠gono
            if (currentPolygon) {
                map.removeLayer(currentPolygon);
            }
            
            currentPolygon = L.polygon(polygonPoints, {
                color: '#007bff',
                fillColor: '#007bff',
                fillOpacity: 0.3,
                weight: 2
            }).addTo(map);
            
            // Mostrar informaci√≥n
            const coordsText = polygonPoints.map((point, i) => 
                `${i + 1}: [${point.lat.toFixed(4)}, ${point.lng.toFixed(4)}]`
            ).join('<br>');
            
            document.getElementById('polygon-coords').innerHTML = coordsText;
            document.getElementById('polygon-info').style.display = 'block';
            document.getElementById('point-info').style.display = 'none';
            
            // Mostrar bot√≥n continuar
            document.getElementById('continueBtn').classList.add('show');
        }
    }

    // Funci√≥n para limpiar pol√≠gono
    function clearPolygon() {
        if (currentPolygon) {
            map.removeLayer(currentPolygon);
            currentPolygon = null;
        }
        
        tempMarkers.forEach(marker => map.removeLayer(marker));
        tempMarkers = [];
        polygonPoints = [];
        
        document.getElementById('polygon-info').style.display = 'none';
        
        // Ocultar bot√≥n continuar
        document.getElementById('continueBtn').classList.remove('show');
    }

    // Evento click en el mapa
    map.on('click', function(e) {
        console.log('Click en mapa:', e.latlng, 'Modo:', currentMode);
        
        if (currentMode === 'point') {
            addPointMarker(e.latlng);
        } else if (currentMode === 'polygon') {
            addPolygonPoint(e.latlng);
        }
    });

    // Evento doble click para cerrar pol√≠gono
    map.on('dblclick', function(e) {
        if (currentMode === 'polygon' && polygonPoints.length >= 3) {
            console.log('Pol√≠gono completado con doble click');
            // El pol√≠gono ya est√° dibujado, solo confirmamos
        }
    });

    // Cambio de modo
    document.getElementById('geometric_options').addEventListener('change', function(e) {
        currentMode = e.target.value;
        console.log('Modo cambiado a:', currentMode);
        
        // Limpiar todo
        if (marker) {
            map.removeLayer(marker);
            marker = null;
        }
        
        clearPolygon();
        
        document.getElementById('point-info').style.display = 'none';
        document.getElementById('polygon-info').style.display = 'none';
        
        // Ocultar bot√≥n continuar
        document.getElementById('continueBtn').classList.remove('show');
        
        // Cambiar ayuda
        if (currentMode === 'point') {
            document.getElementById('help-point').style.display = 'block';
            document.getElementById('help-polygon').style.display = 'none';
        } else {
            document.getElementById('help-point').style.display = 'none';
            document.getElementById('help-polygon').style.display = 'block';
        }
    });

    // Funci√≥n para calcular el centroide de un pol√≠gono
    function calcularCentroide(puntos) {
        let latSum = 0;
        let lngSum = 0;
        
        puntos.forEach(punto => {
            latSum += punto.lat;
            lngSum += punto.lng;
        });
        
        return {
            lat: latSum / puntos.length,
            lng: lngSum / puntos.length
        };
    }

    // Configurar buscador (opcional)
    try {
        const searchControl = L.Control.geocoder({
            position: 'topright',
            defaultMarkGeocode: false,
            geocoder: L.Control.Geocoder.nominatim() //    geocodingQueryParams: { countrycodes: 'pe' }
        }).on('markgeocode', function (e) {
            const latlng = e.geocode.center;
            map.setView(latlng, 16);
            
            if (currentMode === 'point') {
                addPointMarker(latlng);
            }
        }).addTo(map);
        
        // Configurar placeholder del buscador
        setTimeout(() => {
            const input = document.querySelector('.leaflet-control-geocoder input');
            if (input) {
                input.placeholder = "{{ _('Buscar ubicaci√≥n ...') }}";
                input.style.width = '300px';
            }
        }, 200);
        
    } catch(error) {
    }

    // Acci√≥n del bot√≥n
    document.getElementById('continueBtn').addEventListener('click', async function() {
        console.log('Bot√≥n continuar clickeado');
        
        let ubicacionTexto = "Ubicaci√≥n seleccionada";
        let coordenadas = null;
        
        if (currentMode === 'point' && marker) {
            const latlng = marker.getLatLng();
            coordenadas = latlng;
            ubicacionTexto = `Lat: ${latlng.lat.toFixed(6)}, Lng: ${latlng.lng.toFixed(6)}`;
            console.log('Continuando con punto:', latlng);
            
        } else if (currentMode === 'polygon' && currentPolygon) {
            coordenadas = polygonPoints;
            // Crear texto detallado con todas las coordenadas del pol√≠gono
            const coordenadasTexto = polygonPoints.map((point, index) => 
                `P${index + 1}: [${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}]`
            ).join(' | ');
            ubicacionTexto = `Pol√≠gono (${polygonPoints.length} puntos): ${coordenadasTexto}`;
            console.log('Continuando con pol√≠gono:', polygonPoints);
        }
        
        if (coordenadas) {
            const datosMapa = {
                ubicacion: ubicacionTexto,
                coordenadas: coordenadas,
                tipo: currentMode,
                fechaInicio: "2025-10-06",
                fechaFin: "2025-10-10"
            };

            await abrirModalPredictor(datosMapa);
        } else {
            alert('{{ _("Por favor selecciona un punto o dibuja un pol√≠gono primero") }}');
        }
    });

    async function cargarModalPredictor() {
        const contenedor = document.getElementById('contenedorModalPredictor');

        // Cargar solo si a√∫n no est√° insertado
        if (!contenedor.hasChildNodes()) {
            try {
                const response = await fetch('/modal-predictor');
                const html = await response.text();
                contenedor.innerHTML = html;
                
                // Configurar event listeners despu√©s de cargar el HTML
                setTimeout(() => {
                    configurarEventListenersActividades();
                    configurarCierreModal();
                }, 100);
                
            } catch (err) {
                console.error("‚ùå Error al cargar el modal:", err);
            }
        }
    }

    // === FUNCI√ìN para abrir modal y pasar datos ===
    async function abrirModalPredictor(datosMapa) {
        await cargarModalPredictor();

        const modal = document.getElementById('modalPredictorClimatico');
        if (!modal) {
            console.error("‚ùå No se encontr√≥ el modal");
            return;
        }

        modal.style.display = 'flex';

        // Limpiar campos y estados previos
        limpiarModalCompleto();

        // Guardar coordenadas globalmente para la API
        // Verificar si coordenadas es un objeto con lat/lng o un array
        if (datosMapa.coordenadas) {
            if (Array.isArray(datosMapa.coordenadas)) {
                // Es un pol√≠gono, usar el centro
                const centroide = calcularCentroide(datosMapa.coordenadas);
                window.latitudSeleccionada = centroide.lat;
                window.longitudSeleccionada = centroide.lng;
            } else {
                // Es un punto
                window.latitudSeleccionada = datosMapa.coordenadas.lat;
                window.longitudSeleccionada = datosMapa.coordenadas.lng;
            }
        } else {
            // Fallback
            window.latitudSeleccionada = datosMapa.latitud || datosMapa.lat || -6.7714;
            window.longitudSeleccionada = datosMapa.longitud || datosMapa.lon || -79.8405;
        }
        
        console.log(`üìç Coordenadas guardadas: ${window.latitudSeleccionada}, ${window.longitudSeleccionada}`);

        // Reconfigurar event listeners de actividades
        configurarEventListenersActividades();

        // Rellenar los campos del modal
        setTimeout(() => {
            const ubicacionField = document.getElementById('ubicacion');
            const fechaInicioField = document.getElementById('fechaInicio');
            const fechaFinField = document.getElementById('fechaFin');
            
            if (ubicacionField) ubicacionField.value = datosMapa.ubicacion;
            if (fechaInicioField) fechaInicioField.value = datosMapa.fechaInicio;
            if (fechaFinField) fechaFinField.value = datosMapa.fechaFin;
            
            console.log("‚úÖ Campos del modal rellenados");
        }, 50);
    }
    
    // Funci√≥n para configurar el cierre del modal
    function configurarCierreModal() {
        const modal = document.getElementById('modalPredictorClimatico');
        if (!modal) return;
        
        // Funci√≥n global para cerrar modal
        window.cerrarModalPredictor = function() {
            console.log('üî¥ Cerrando modal predictor...');
            modal.style.display = 'none';
            
            // Limpiar campos principales
            const ubicacion = document.getElementById('ubicacion');
            const fechaInicio = document.getElementById('fechaInicio');
            const fechaFin = document.getElementById('fechaFin');
            
            if (ubicacion) ubicacion.value = '';
            if (fechaInicio) fechaInicio.value = '';
            if (fechaFin) fechaFin.value = '';
            
            // Limpiar campo de actividad personalizada
            const actividadPersonalizada = document.getElementById('actividadPersonalizada');
            const customActivityContainer = document.getElementById('customActivityContainer');
            
            if (actividadPersonalizada) actividadPersonalizada.value = '';
            if (customActivityContainer) {
                customActivityContainer.style.display = 'none';
                customActivityContainer.classList.remove('show');
            }
            
            // Ocultar resultados
            const resultados = document.getElementById('resultadosAnalisis');
            if (resultados) resultados.style.display = 'none';
            
            // Limpiar actividades
            const activityBtns = document.querySelectorAll('.activity-btn');
            activityBtns.forEach(btn => btn.classList.remove('active'));
            
            console.log('‚úÖ Modal cerrado y limpiado');
        };
        
        // Event listener para click fuera del modal
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                window.cerrarModalPredictor();
            }
        });
        
        // Event listener para tecla Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal.style.display !== 'none') {
                window.cerrarModalPredictor();
            }
        });
        
        // Buscar bot√≥n de cerrar y configurarlo
        const closeBtn = modal.querySelector('.modal-close');
        if (closeBtn) {
            closeBtn.onclick = window.cerrarModalPredictor;
        }
        
        console.log('üîß Event listeners del modal configurados');
    }

    // Funci√≥n para limpiar completamente el modal
    function limpiarModalCompleto() {
        // Limpiar campos de texto
        const ubicacion = document.getElementById('ubicacion');
        const fechaInicio = document.getElementById('fechaInicio');
        const fechaFin = document.getElementById('fechaFin');
        const actividadPersonalizada = document.getElementById('actividadPersonalizada');
        
        if (ubicacion) ubicacion.value = '';
        if (fechaInicio) fechaInicio.value = '';
        if (fechaFin) fechaFin.value = '';
        if (actividadPersonalizada) actividadPersonalizada.value = '';
        
        // Limpiar selecci√≥n de actividades
        const activityBtns = document.querySelectorAll('.activity-btn');
        activityBtns.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.activity === 'otra') {
                delete btn.dataset.actividadPersonalizada;
            }
        });
        
        // Ocultar resultados
        const resultados = document.getElementById('resultadosAnalisis');
        if (resultados) resultados.style.display = 'none';
        
        console.log('üßπ Modal limpiado completamente');
    }

    // Funci√≥n para configurar event listeners de las actividades
    function configurarEventListenersActividades() {
        const activityBtns = document.querySelectorAll('.activity-btn');
        
        activityBtns.forEach(btn => {
            // Remover event listeners anteriores clonando el elemento
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            // Agregar nuevo event listener
            newBtn.addEventListener('click', function(e) {
                // Si es el campo personalizado y se clickea el input, no hacer nada
                if (e.target.tagName === 'INPUT') {
                    return;
                }
                
                // Remover active de todos
                document.querySelectorAll('.activity-btn').forEach(b => b.classList.remove('active'));
                
                // Agregar active al clickeado
                newBtn.classList.add('active');
                
                // Si es actividad personalizada, enfocar el input
                if (newBtn.dataset.activity === 'otra') {
                    const input = newBtn.querySelector('input');
                    if (input) {
                        setTimeout(() => input.focus(), 50);
                    }
                }
                
                console.log('‚úÖ Actividad seleccionada:', newBtn.dataset.activity);
            });
        });
        
        // Configurar input de actividad personalizada
        const customInput = document.getElementById('actividadPersonalizada');
        if (customInput) {
            const customBtn = customInput.closest('.activity-btn');
            
            customInput.addEventListener('focus', function() {
                if (customBtn) {
                    document.querySelectorAll('.activity-btn').forEach(b => b.classList.remove('active'));
                    customBtn.classList.add('active');
                }
            });
            
            customInput.addEventListener('input', function() {
                if (customBtn) {
                    customBtn.dataset.actividadPersonalizada = this.value.trim();
                }
            });
        }
        
        console.log('üîß Event listeners de actividades configurados');
    }

    // ===== FUNCI√ìN PARA EXPORTAR A PDF =====
    window.exportarAPDF = async function() {
        const btnExportar = document.querySelector('.btn-exportar');
        const textoOriginal = btnExportar.innerHTML;
        
        try {
            btnExportar.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="2" fill="none"/></svg> Generando PDF...';
            btnExportar.disabled = true;
            
            console.log('üìÑ Iniciando exportaci√≥n a PDF...');
            
            // Obtener el contenedor de resultados
            const resultadosDiv = document.getElementById('resultadosAnalisis');
            if (!resultadosDiv) {
                alert('{{ _("No hay resultados para exportar") }}');
                return;
            }
            
            // Crear un contenedor temporal para el PDF
            const pdfContainer = document.createElement('div');
            pdfContainer.style.width = '800px';
            pdfContainer.style.padding = '40px';
            pdfContainer.style.backgroundColor = 'white';
            pdfContainer.style.position = 'absolute';
            pdfContainer.style.left = '-9999px';
            document.body.appendChild(pdfContainer);
            
            // Obtener datos del formulario
            const ubicacion = document.getElementById('ubicacion')?.value || 'Ubicaci√≥n no especificada';
            const fechaInicio = document.getElementById('fechaInicio')?.value || '';
            const fechaFin = document.getElementById('fechaFin')?.value || '';
            const actividadBtn = document.querySelector('.activity-btn.active');
            let actividad = 'No especificada';
            
            if (actividadBtn) {
                if (actividadBtn.dataset.activity === 'otra') {
                    const input = actividadBtn.querySelector('input');
                    actividad = input ? input.value : actividadBtn.dataset.actividadPersonalizada || 'Otra';
                } else {
                    const span = actividadBtn.querySelector('span');
                    actividad = span ? span.textContent : actividadBtn.dataset.activity;
                }
            }
            
            // Construir el contenido del PDF
            pdfContainer.innerHTML = `
                <div style="font-family: Arial, sans-serif;">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #7fb539; padding-bottom: 20px;">
                        <h1 style="color: #7fb539; margin: 0 0 10px 0; font-size: 28px;">üå¶Ô∏è Climate Report</h1>
                        <p style="color: #666; margin: 0; font-size: 14px;">Weather Forecasting with ML</p>
                    </div>
                    
                    <div style="margin-bottom: 25px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <h2 style="color: #333; font-size: 18px; margin: 0 0 15px 0;">üìç Travel Information</h2>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <td style="padding: 8px 0; color: #666; font-weight: bold; width: 150px;">Location:</td>
                                <td style="padding: 8px 0; color: #333;">${ubicacion}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; color: #666; font-weight: bold;">Coordinates:</td>
                                <td style="padding: 8px 0; color: #333;">${window.latitudSeleccionada?.toFixed(6) || 'N/A'}, ${window.longitudSeleccionada?.toFixed(6) || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; color: #666; font-weight: bold;">Start Date:</td>
                                <td style="padding: 8px 0; color: #333;">${fechaInicio}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; color: #666; font-weight: bold;">End Date:</td>
                                <td style="padding: 8px 0; color: #333;">${fechaFin}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; color: #666; font-weight: bold;">Activity:</td>
                                <td style="padding: 8px 0; color: #333;">${actividad}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div id="chartForPDF" style="margin: 25px 0;">
                        <h2 style="color: #333; font-size: 18px; margin: 0 0 15px 0;">üìä Expected temperature</h2>
                        <canvas id="tempChartPDF" width="720" height="300"></canvas>
                    </div>
                    
                    <div style="margin: 25px 0;">
                        <h2 style="color: #333; font-size: 18px; margin: 0 0 15px 0;">üå§Ô∏è Daily Forecast</h2>
                        <div id="weatherDaysPDF"></div>
                    </div>
                    
                    <div id="recomendacionPDF"></div>
                    
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #eee; text-align: center; color: #999; font-size: 11px;">
                        <p style="color: #000000;">Generated on ${new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                        <p style="color: #000000;">Model: XGBoost Gradient Boosting | Source: NASA MERRA-2</p>
                    </div>
                </div>
            `;
            
            // Copiar el gr√°fico al contenedor temporal
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Recrear el gr√°fico en el canvas del PDF
            if (window.chartTemperatura && typeof Chart !== 'undefined') {
                const canvasPDF = document.getElementById('tempChartPDF');
                const ctxPDF = canvasPDF.getContext('2d');
                
                // Clonar solo los datos necesarios
                const chartData = window.chartTemperatura.data;
                
                new Chart(ctxPDF, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: chartData.datasets.map(ds => ({
                            label: ds.label,
                            data: ds.data,
                            borderColor: ds.borderColor,
                            backgroundColor: ds.backgroundColor,
                            tension: 0.4,
                            borderWidth: ds.borderWidth || 1
                        }))
                    },
                    options: {
                        responsive: false,
                        animation: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            title: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return value + '¬∞C';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Copiar los d√≠as del clima
            const weatherDaysPDF = document.getElementById('weatherDaysPDF');
            const weatherDays = document.querySelectorAll('.weather-day');
            let weatherHTML = '<div style="display: flex; justify-content: space-between; flex-wrap: wrap;">';
            
            weatherDays.forEach(day => {
                const label = day.querySelector('.day-label')?.textContent || '';
                const icon = day.querySelector('.weather-icon')?.innerHTML || '‚òÄÔ∏è';
                weatherHTML += `
                    <div style="text-align: center; margin: 10px; min-width: 70px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">${label}</div>
                        <div style="font-size: 36px;">${icon}</div>
                    </div>
                `;
            });
            weatherHTML += '</div>';
            weatherDaysPDF.innerHTML = weatherHTML;
            
            // Copiar la recomendaci√≥n
            const recomendacionPDF = document.getElementById('recomendacionPDF');
            const recomendacionOriginal = document.querySelector('.recommendation-box');
            if (recomendacionOriginal) {
                const bgColor = recomendacionOriginal.style.backgroundColor || '#fef9e7';
                const borderColor = recomendacionOriginal.style.borderColor || '#f9e79f';
                const texto = recomendacionOriginal.querySelector('.recommendation-text')?.textContent || '';
                
                recomendacionPDF.innerHTML = `
                    <div style="background-color: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 8px; padding: 20px; margin: 25px 0;">
                        <h2 style="color: #333; font-size: 18px; margin: 0 0 10px 0;">üí° Recommendation</h2>
                        <p style="color: #666; font-size: 14px; line-height: 1.6; margin: 0;">${texto}</p>
                    </div>
                `;
            }
            
            // Esperar a que todo se renderice
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Capturar el contenido con html2canvas
            const canvas = await html2canvas(pdfContainer, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            });
            
            // Crear PDF con jsPDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 210; // A4 width in mm
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            let heightLeft = imgHeight;
            let position = 0;
            
            // Agregar p√°ginas si el contenido es muy largo
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= 297; // A4 height in mm
            
            while (heightLeft > 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= 297;
            }
            
            // Guardar el PDF
            const nombreArchivo = `reporte_climatico_${fechaInicio}_${fechaFin}.pdf`;
            pdf.save(nombreArchivo);
            
            // Limpiar
            document.body.removeChild(pdfContainer);
            
            console.log('‚úÖ PDF generado exitosamente:', nombreArchivo);
            
            // Mostrar mensaje de √©xito
            alert("{{ _('‚úÖ PDF generado exitosamente: ') }}" + nombreArchivo);
            
        } catch (error) {
            console.error('‚ùå Error al generar PDF:', error);
            alert("{{ _('Error al generar PDF: ') }}" + error.message);
        } finally {
            btnExportar.innerHTML = textoOriginal;
            btnExportar.disabled = false;
        }
    };

    // ===== FUNCIONES DEL PREDICTOR CLIM√ÅTICO (GLOBALES) =====
    
    window.analizarCondiciones = async function() {
        const ubicacion = document.getElementById('ubicacion')?.value;
        const fechaInicio = document.getElementById('fechaInicio')?.value;
        const fechaFin = document.getElementById('fechaFin')?.value;

        const actividadSeleccionada = document.querySelector('.activity-btn.active');
        let actividad = '';

        if (actividadSeleccionada) {
            if (actividadSeleccionada.dataset.activity === 'otra') {
                const inputEnBoton = actividadSeleccionada.querySelector('input');
                if (inputEnBoton) {
                    actividad = inputEnBoton.value.trim();
                } else if (actividadSeleccionada.dataset.actividadPersonalizada) {
                    actividad = actividadSeleccionada.dataset.actividadPersonalizada.trim();
                }

                if (!actividad) {
                    alert(`{{ _('Por favor escribe tu actividad en el campo "Otra"') }} `);
                    if (inputEnBoton) inputEnBoton.focus();
                    return;
                }
            } else {
                const spanActividad = actividadSeleccionada.querySelector('span');
                actividad = spanActividad ? spanActividad.textContent : '';
            }
        }

        if (!ubicacion || !fechaInicio || !fechaFin || !actividad) {
            alert("{{ _('Por favor completa todos los campos y selecciona una actividad') }}");
            return;
        }

        // Obtener coordenadas guardadas globalmente
        let lat = window.latitudSeleccionada || -6.7714; // Default Chiclayo
        let lon = window.longitudSeleccionada || -79.8405;

        console.log(`üìç Usando coordenadas: ${lat}, ${lon}`);

        // Mostrar loading
        const btnAnalizar = document.querySelector('.btn-analizar');
        const textoOriginal = btnAnalizar.textContent;
        btnAnalizar.textContent = 'üîÑ Analizando...';
        btnAnalizar.disabled = true;

        try {
            console.log('üå¶Ô∏è Llamando a API de predicci√≥n...');
            console.log(`üìç Ubicaci√≥n: ${lat}, ${lon}`);
            console.log(`üìÖ Fechas: ${fechaInicio} ‚Üí ${fechaFin}`);
            
            // Llamar a la API
            const response = await fetch('/api/climate/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    lat: lat,
                    lon: lon,
                    fecha_inicio: fechaInicio,
                    fecha_fin: fechaFin
                })
            });

            const result = await response.json();

            if (result.success) {
                console.log('‚úÖ Predicci√≥n recibida:', result.data);
                
                // Mostrar si son datos simulados
                if (result.data.nota && result.data.nota.includes('SIMULADO')) {
                    console.warn('‚ö†Ô∏è DATOS SIMULADOS:', result.data.nota);
                }
                
                // Mostrar resultados
                window.mostrarResultadosClimaticos(result.data, actividad);
                
                const resultados = document.getElementById('resultadosAnalisis');
                if (resultados) {
                    resultados.style.display = 'block';
                    resultados.scrollIntoView({ behavior: 'smooth' });
                }
            } else {
                console.error('‚ùå Error en API:', result.error);
                alert("{{ _('Error al obtener predicci√≥n: ') }}" + result.error);
            }
        } catch (error) {
            console.error('‚ùå Error en petici√≥n:', error);
            alert("{{ _('Error de conexi√≥n: ') }}" + error.message);
        } finally {
            btnAnalizar.textContent = textoOriginal;
            btnAnalizar.disabled = false;
        }
    };

    window.mostrarResultadosClimaticos = function(data, actividad) {
        const predicciones = data.predicciones;
        
        // Actualizar t√≠tulo con nota si hay
        const tituloResultados = document.querySelector('.resultados-title');
        if (tituloResultados) {
            let texto = 'An√°lisis de Riesgos Clim√°ticos';
            if (data.nota && data.nota.includes('SIMULADO')) {
                texto += ' (‚ö†Ô∏è Datos Simulados)';
            }
            tituloResultados.textContent = texto;
        }
        
        // Actualizar gr√°fico de temperatura
        window.actualizarGraficoTemperatura(predicciones);
        
        // Actualizar √≠conos del clima por d√≠a
        window.actualizarIconosClima(predicciones);
        
        // Actualizar recomendaci√≥n
        window.actualizarRecomendacion(predicciones, actividad, data.ubicacion);
        
        console.log('üìä Resultados mostrados en el modal');
    };

    window.actualizarGraficoTemperatura = function(predicciones) {
        const canvas = document.getElementById('chartTemperatura');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Destruir gr√°fico anterior si existe
        if (window.chartTemperatura && typeof window.chartTemperatura.destroy === 'function') {
            window.chartTemperatura.destroy();
        }
        
        const labels = predicciones.map(p => {
            const fecha = new Date(p.fecha);
            return fecha.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' });
        });
        
        const temperaturas = predicciones.map(p => p.temperatura.valor);
        const tempMax = predicciones.map(p => p.temperatura.max);
        const tempMin = predicciones.map(p => p.temperatura.min);
        
        // Crear gr√°fico con Chart.js si est√° disponible
        if (typeof Chart !== 'undefined') {
            window.chartTemperatura = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'M√°xima',
                            data: tempMax,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Promedio',
                            data: temperaturas,
                            borderColor: '#4ecdc4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            tension: 0.4,
                            borderWidth: 2
                        },
                        {
                            label: 'M√≠nima',
                            data: tempMin,
                            borderColor: '#45b7d1',
                            backgroundColor: 'rgba(69, 183, 209, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Temperatura (¬∞C)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        } else {
            console.warn('‚ö†Ô∏è Chart.js no disponible');
        }
    };

    window.actualizarIconosClima = function(predicciones) {
        const weatherDays = document.querySelectorAll('.weather-day');
        
        predicciones.slice(0, 8).forEach((pred, index) => {
            if (index < weatherDays.length) {
                const dayElement = weatherDays[index];
                
                // Actualizar etiqueta del d√≠a
                const dayLabel = dayElement.querySelector('.day-label');
                if (dayLabel) {
                    const fecha = new Date(pred.fecha);
                    dayLabel.textContent = fecha.toLocaleDateString('es-ES', { weekday: 'short' });
                }
                
                // Actualizar √≠cono seg√∫n lluvia
                const icon = dayElement.querySelector('.weather-icon');
                if (icon) {
                    const llover√° = pred.precipitacion.llover√°;
                    const prob = pred.precipitacion.probabilidad;
                    
                    if (llover√° || prob > 50) {
                        icon.innerHTML = 'üåßÔ∏è';
                        icon.title = `Lluvia ${prob.toFixed(0)}%`;
                    } else if (prob > 30) {
                        icon.innerHTML = '‚õÖ';
                        icon.title = `Parcialmente nublado ${prob.toFixed(0)}%`;
                    } else {
                        icon.innerHTML = '‚òÄÔ∏è';
                        icon.title = `Despejado ${prob.toFixed(0)}%`;
                    }
                }
            }
        });
    };

    window.actualizarRecomendacion = function(predicciones, actividad, ubicacion) {
        const recomText = document.querySelector('.recommendation-text');
        if (!recomText) return;
        
        // Analizar condiciones
        const tempPromedio = predicciones.reduce((sum, p) => sum + p.temperatura.valor, 0) / predicciones.length;
        const probLluviaMax = Math.max(...predicciones.map(p => p.precipitacion.probabilidad));
        const diasLluvia = predicciones.filter(p => p.precipitacion.llover√°).length;
        
        let recomendacion = '';
        let nivel = 'favorable'; // favorable, precaucion, desfavorable
        
        if (probLluviaMax > 70 || diasLluvia > 3) {
            nivel = 'desfavorable';
            recomendacion = `‚ö†Ô∏è Condiciones desfavorables: Alta probabilidad de lluvia (${probLluviaMax.toFixed(0)}%) durante ${diasLluvia} d√≠as. Se recomienda reprogramar la actividad de ${actividad} o llevar equipo impermeable adecuado.`;
        } else if (probLluviaMax > 40 || diasLluvia > 1) {
            nivel = 'precaucion';
            recomendacion = `‚ö†Ô∏è Precauci√≥n: Probabilidad moderada de lluvia (${probLluviaMax.toFixed(0)}%). La actividad de ${actividad} es posible con precauci√≥n. Llevar equipo para lluvia y estar atento al clima.`;
        } else {
            nivel = 'favorable';
            recomendacion = `‚úÖ Condiciones favorables: Clima mayormente despejado con temperatura promedio de ${tempPromedio.toFixed(1)}¬∞C. Ideal para ${actividad}. Probabilidad de lluvia baja (${probLluviaMax.toFixed(0)}%).`;
        }
        
        recomText.textContent = recomendacion;
        
        // Cambiar color del cuadro seg√∫n nivel
        const recomBox = document.querySelector('.recommendation-box');
        if (recomBox) {
            if (nivel === 'desfavorable') {
                recomBox.style.backgroundColor = '#fee';
                recomBox.style.borderColor = '#fcc';
            } else if (nivel === 'precaucion') {
                recomBox.style.backgroundColor = '#fef9e7';
                recomBox.style.borderColor = '#f9e79f';
            } else {
                recomBox.style.backgroundColor = '#efe';
                recomBox.style.borderColor = '#cfc';
            }
        }
    };

</script>
{% endblock %}