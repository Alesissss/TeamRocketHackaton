{% extends "master_page.html" %}

{% block title %}Choose an address{% endblock %}

{% block style %}
<link rel="stylesheet" href="{{ url_for('home.static_files', filename='css/map.css') }}" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

<style>
#map {
    height: 600px;
    width: 100%;
    cursor: grab;
    border-radius: 14px;
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
}
#map:active {
    cursor: grabbing;
}

/* === Leyenda (abajo a la derecha) === */
.coordinates-box {
    position: absolute;
    z-index: 1000;
    bottom: 90px; /* Deja espacio para el bot√≥n */
    right: 20px;
    background: white;
    padding: 18px;
    border-radius: 12px;
    box-shadow: 0 4px 14px rgba(0, 0, 0, 0.3);
    max-width: 340px;
    font-size: 16px;
    font-weight: 500;
}
.coordinates-box strong {
    color: #222;
    font-size: 18px;
}

/* === Botones grandes de dibujo === */
.leaflet-draw-toolbar a {
    width: 46px !important;
    height: 46px !important;
    line-height: 46px !important;
    background-size: 70% auto !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
}
.leaflet-draw-toolbar a:hover {
    transform: scale(1.15);
    transition: all 0.2s ease;
}

/* === Restaurar √≠conos de Leaflet Draw === */
.leaflet-draw-draw-polygon {
    background-image: url('https://unpkg.com/leaflet-draw@1.0.4/dist/images/spritesheet.svg');
    background-position: -2px -2px;
}
.leaflet-draw-edit-edit {
    background-image: url('https://unpkg.com/leaflet-draw@1.0.4/dist/images/spritesheet.svg');
    background-position: -32px -2px;
}
.leaflet-draw-edit-remove {
    background-image: url('https://unpkg.com/leaflet-draw@1.0.4/dist/images/spritesheet.svg');
    background-position: -62px -2px;
}

/* === Botones de zoom m√°s grandes === */
.leaflet-control-zoom a {
    width: 46px !important;
    height: 46px !important;
    line-height: 46px !important;
    font-size: 28px !important;
    font-weight: bold;
}

/* === Bot√≥n bonito "Seleccionar zona" / Continuar === */
.selected-cordinates {
    position: absolute;
    z-index: 1100;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
}

.selected-cordinates button {
    background: linear-gradient(135deg, #0078ff, #00c3ff);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 14px 32px;
    font-size: 17px;
    font-weight: 600;
    box-shadow: 0 6px 18px rgba(0, 120, 255, 0.4);
    cursor: pointer;
    transition: all 0.25s ease;
}

.selected-cordinates button:hover {
    background: linear-gradient(135deg, #0066e4, #00a7e4);
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 120, 255, 0.5);
}

.selected-cordinates button:active {
    transform: scale(0.97);
}

/* === Ajuste m√≥vil === */
@media (max-width: 768px) {
    .coordinates-box {
        bottom: 100px;
        right: 10px;
        left: 10px;
        max-width: none;
        font-size: 14px;
        padding: 10px;
    }

    .selected-cordinates button {
        width: 90%;
        font-size: 15px;
        padding: 12px 0;
    }
    #contenedorModalPredictor{
        width: 100%;
        height: 100%;
        margin: 15%;
    }
}
</style>
{% endblock %}

{% block body %}
<div class="col-md-6 position-relative">
    <div id="map"></div>
    <select name="geometric_options" id="geometric_options" class="options">
        <option value="point">üìç Punto</option>
        <option value="polygon">üî∑ Pol√≠gono</option>
    </select>
    
    <!-- Informaci√≥n de coordenadas -->
    <div id="coordinates-info" class="coordinates-box">
        <div id="point-info" style="display: none;">
            <strong>Punto seleccionado:</strong><br>
            Lat: <span id="lat">-</span>, Lng: <span id="lng">-</span>
        </div>
        <div id="polygon-info" style="display: none;">
            <strong>Pol√≠gono dibujado:</strong><br>
            <span id="polygon-coords">-</span>
        </div>
    </div>

    <!-- Bot√≥n de continuar -->
    <div class="selected-cordinates">
        <button id="continueBtn">Seleccionar zona</button>
    </div>
    <div id="contenedorModalPredictor"></div>

</div>
{% endblock %}

{% block script %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script>
    // Configuraci√≥n del mapa
    const map = L.map('map', { 
        dragging: true, 
        zoomControl: true 
    }).setView([-9.19, -75.0152], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        minZoom: 6,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Variables globales
    let marker;
    let currentMode = 'point';
    let drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    
    let drawControl;
    let currentPolygon = null;

    // Configuraci√≥n del buscador
    const searchControl = L.Control.geocoder({
        position: 'topright',
        defaultMarkGeocode: false,
        geocoder: L.Control.Geocoder.nominatim({
            geocodingQueryParams: { countrycodes: 'pe' }
        })
    }).on('markgeocode', function (e) {
        const latlng = e.geocode.center;
        map.setView(latlng, 16);
        if (currentMode === 'point') {
            if (!marker) marker = L.marker(latlng).addTo(map);
            else marker.setLatLng(latlng);
            updatePointInfo(latlng);
        }
    }).addTo(map);

    // Funci√≥n para actualizar informaci√≥n del punto
    function updatePointInfo(latlng) {
        document.getElementById('lat').textContent = latlng.lat.toFixed(6);
        document.getElementById('lng').textContent = latlng.lng.toFixed(6);
        document.getElementById('point-info').style.display = 'block';
        document.getElementById('polygon-info').style.display = 'none';
    }

    // Funci√≥n para actualizar informaci√≥n del pol√≠gono
    function updatePolygonInfo(layer) {
        const coords = layer.getLatLngs()[0];
        const coordText = coords.map((c, i) => 
            `P${i + 1}: (${c.lat.toFixed(4)}, ${c.lng.toFixed(4)})`
        ).join('<br>');
        document.getElementById('polygon-coords').innerHTML = coordText;
        document.getElementById('polygon-info').style.display = 'block';
        document.getElementById('point-info').style.display = 'none';
    }

    // Inicializa controles de dibujo
    function initDrawControl() {
        if (drawControl) map.removeControl(drawControl);
        drawControl = new L.Control.Draw({
            draw: {
                polygon: {
                    allowIntersection: false,
                    showArea: true,
                    shapeOptions: {
                        color: '#3388ff',
                        weight: 3
                    }
                },
                polyline: false,
                rectangle: false,
                circle: false,
                marker: false,
                circlemarker: false
            },
            edit: { featureGroup: drawnItems, remove: true }
        });
        map.addControl(drawControl);
    }

    // Cambio de modo (punto o pol√≠gono)
    document.getElementById('geometric_options').addEventListener('change', function(e) {
        currentMode = e.target.value;
        drawnItems.clearLayers();
        if (marker) map.removeLayer(marker);
        marker = null;
        document.getElementById('point-info').style.display = 'none';
        document.getElementById('polygon-info').style.display = 'none';
        
        if (currentMode === 'polygon') {
            initDrawControl();
            map.off('click');
        } else {
            if (drawControl) map.removeControl(drawControl);
            map.on('click', function(e) {
                if (currentMode === 'point') {
                    if (!marker) marker = L.marker(e.latlng).addTo(map);
                    else marker.setLatLng(e.latlng);
                    updatePointInfo(e.latlng);
                }
            });
        }
    });

    // Eventos de dibujo
    map.on(L.Draw.Event.CREATED, function (e) {
        const layer = e.layer;
        drawnItems.clearLayers();
        drawnItems.addLayer(layer);
        currentPolygon = layer;
        updatePolygonInfo(layer);
    });

    map.on(L.Draw.Event.EDITED, function (e) {
        e.layers.eachLayer(updatePolygonInfo);
    });

    map.on(L.Draw.Event.DELETED, function () {
        document.getElementById('polygon-info').style.display = 'none';
        currentPolygon = null;
    });

    // Click para crear puntos
    map.on('click', function(e) {
        if (currentMode === 'point') {
            if (!marker) marker = L.marker(e.latlng).addTo(map);
            else marker.setLatLng(e.latlng);
            updatePointInfo(e.latlng);
        }
    });

    // Ajustar campo de b√∫squeda
    setTimeout(() => {
        const input = document.querySelector('.leaflet-control-geocoder input');
        if (input) {
            input.placeholder = "Buscar ubicaci√≥n en Per√∫...";
            input.style.width = '350px';
        }
    }, 300);

    // Acci√≥n del bot√≥n
    document.getElementById('continueBtn').addEventListener('click', async function() {
        const datosPrueba = {
            ubicacion: "Cajamarca, Per√∫",
            fechaInicio: "2025-10-06",
            fechaFin: "2025-10-10"
        };

        await abrirModalPredictor(datosPrueba);
    });

    async function cargarModalPredictor() {
        const contenedor = document.getElementById('contenedorModalPredictor');

        // Cargar solo si a√∫n no est√° insertado
        if (!contenedor.hasChildNodes()) {
            try {
                const response = await fetch('/modal-predictor');
                const html = await response.text();
                contenedor.innerHTML = html;
                console.log("‚úÖ Modal cargado desde Flask");
            } catch (err) {
                console.error("‚ùå Error al cargar el modal:", err);
            }
        }
    }

    // === FUNCI√ìN para abrir modal y pasar datos ===
    async function abrirModalPredictor(datosMapa) {
        await cargarModalPredictor();

        const modal = document.getElementById('modalPredictorClimatico');
        if (!modal) return;

        modal.style.display = 'flex';

        // Rellenar los campos del modal
        document.getElementById('ubicacion').value = datosMapa.ubicacion;
        document.getElementById('fechaInicio').value = datosMapa.fechaInicio;
        document.getElementById('fechaFin').value = datosMapa.fechaFin;
    }
</script>
{% endblock %}
